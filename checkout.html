<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Checkout • Template Studio</title>
    <link rel="stylesheet" href="./style.css" />
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
    <script> 
      (function(){ 
        console.log('Initializing EmailJS...');
        emailjs.init('i9YXPhDlFNnEo68Tm'); 
        console.log('EmailJS initialized with public key:', 'i9YXPhDlFNnEo68Tm');
      })(); 
    </script>
  </head>
  <body>
    <header class="header">
      <div class="container row" style="display:flex;justify-content:space-between;align-items:center">
        <div class="brand">
          <img src="./assets/LOGO.jpg" alt="Template Studio Logo" class="logo" />
          <span>Template Studio</span>
        </div>
        <nav class="nav">
          <a href="./index.html">Home</a>
        </nav>
      </div>
    </header>
    <main class="container">
      <h1>Checkout</h1>
      <div id="summary" class="card" style="padding:16px"></div>
      <div class="card" style="padding:16px; margin-top:12px; display:grid; gap:12px">
        <div class="row">
          <label style="min-width:120px">Your email *</label>
          <div style="flex-grow:1">
            <input 
              id="email" 
              class="input" 
              type="email" 
              placeholder="you@example.com" 
              pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"
              title="Please enter a valid email address (e.g., name@example.com)"
              required 
            />
            <div class="muted" style="font-size:0.8em;margin-top:4px;">Enter a valid email address where you'll receive the Canva links</div>
          </div>
        </div>
        <div class="row"><label style="min-width:120px">Message *</label><textarea id="message" class="input" placeholder="Please provide your order number and ensure your email is valid. The Canva link will be sent to your email." required style="min-height:80px; resize:vertical;"></textarea></div>
        <div class="row" style="align-items:flex-start">
          <div style="min-width:120px">Payment proof *</div>
          <div>
            <input id="screenshot" type="file" accept="image/*" required />
            <div class="muted" style="margin-top:6px">Upload a screenshot after you scan and pay.</div>
            <img id="shotPrev" src="" alt="Preview" style="display:none;max-width:260px;max-height:200px;margin-top:8px;border:1px solid var(--border);border-radius:8px" />
          </div>
        </div>
        <div style="display:grid; gap:12px">
          <div class="row">
            <label style="min-width:120px">Payment Method *</label>
            <select id="method" class="input" required>
              <option value="" selected disabled>Select payment method</option>
              <option value="esewa">eSewa</option>
              <option value="payoneer">Payoneer</option>
              <option value="bank">Bank Transfer</option>
            </select>
          </div>
          
          <div id="paymentDetails" style="display:none; margin-left: 120px; padding:12px; background:rgba(255,255,255,0.05); border-radius:8px;">
            <div id="esewaDetails" class="payment-details" style="display:none">
              <h4 style="margin:0 0 8px 0">eSewa Payment Details</h4>
              <p style="margin:0 0 4px 0">Send payment to:</p>
              <p style="margin:0 0 8px 0"><strong>eSewa ID:</strong> 9828808007</p>
              <img src="./assets/qr-esewa.png" alt="eSewa QR" style="max-width:200px; border-radius:8px;" />
            </div>
            <div id="payoneerDetails" class="payment-details" style="display:none">
              <h4 style="margin:0 0 8px 0">Payoneer Payment Details</h4>
              <p style="margin:0 0 4px 0">Send payment to:</p>
              <p style="margin:0 0 8px 0"><strong>Email:</strong> thetemplatestudio48@gmail.com</p>
            </div>
            <div id="bankDetails" class="payment-details" style="display:none">
              <h4 style="margin:0 0 8px 0">Bank Transfer Details</h4>
              <p style="margin:0 0 4px 0"><strong>Bank:</strong> Siddhartha bank limited</p>
              <p style="margin:0 0 4px 0"><strong>Account Name:</strong> Biraj Gamal</p>
              <p style="margin:0 0 4px 0"><strong>Account Number:</strong> 55507531425</p>
              <p style="margin:0 0 8px 0"><strong>Branch:</strong> Kalopul Branch</p>
              <img src="./assets/qr-bank.jpg" alt="Bank QR" style="max-width:200px; border-radius:8px;" />
            </div>
          </div>

          <div class="row" style="gap:8px">
            <button id="confirm" class="btn primary">Confirm Order</button>
            <a class="btn" href="./cart.html">Back to cart</a>
          </div>
        </div>
      </div>
    </main>

    <footer class="footer">© <span id="year"></span> Template Studio</footer>

    <script>
      const fmt = v => (v / 100).toFixed(2);
      const order = JSON.parse(localStorage.getItem('last-order') || 'null');
      document.getElementById('year').textContent = new Date().getFullYear();
      if (!order) {
        document.getElementById('summary').innerHTML = '<div class="muted">No order to checkout.</div>';
      } else {
        // Filter out products with $0.00 prices
        const validItems = order.items.filter(i => (i.priceCents * i.quantity) > 0);
        const invalidItems = order.items.filter(i => (i.priceCents * i.quantity) === 0);
        
        let list = '';
        if (validItems.length > 0) {
          list = validItems.map(i => `<li><strong>${i.title}</strong> × ${i.quantity} — $${fmt(i.priceCents*i.quantity)}</li>`).join('');
        }
        
        const totalCents = validItems.reduce((s, i) => s + (i.priceCents * i.quantity), 0);
        
        document.getElementById('summary').innerHTML = `
          <p><strong>Email:</strong> ${order.email}</p>
          ${list ? `<ul style="margin:0 0 8px 16px">${list}</ul>` : '<p class="muted">No valid products found.</p>'}
          <p><strong>Total:</strong> $${fmt(totalCents)}</p>
        `;
      }

      const ordersKey = 'orders';
      const readOrders = () => JSON.parse(localStorage.getItem(ordersKey) || '[]');
      const writeOrders = (list) => localStorage.setItem(ordersKey, JSON.stringify(list));
      
      // Generate order ID starting from 001
      function generateOrderId() {
        const orders = readOrders();
        
        // Find the highest existing order ID
        let highestId = 0;
        orders.forEach(order => {
          // Check if order.id is a number (001, 002, etc.)
          if (order.id && /^\d+$/.test(order.id)) {
            const numId = parseInt(order.id, 10);
            if (numId > highestId) {
              highestId = numId;
            }
          }
        });
        
        // Generate next sequential ID
        const nextId = highestId + 1;
        return nextId.toString().padStart(3, '0'); // 001, 002, 003, etc.
      }
      
      // Test EmailJS connection
      async function testEmailJS() {
        try {
          console.log('Testing EmailJS connection...');
          const testData = {
            to_email: 'birajshrestha145@gmail.com',
            from_email: 'test@example.com',
            order_id: 'TEST001',
            customer_email: 'test@example.com',
            order_items: 'Test Product × 1 — $10.00',
            order_total: '10.00',
            customer_message: 'This is a test message',
            payment_proof: 'Test payment'
          };
          
          const result = await emailjs.send('service_a2r2ht3', 'template_0bxfv93', testData);
          console.log('EmailJS test successful:', result);
          alert('EmailJS is working! Test email sent.');
          return true;
        } catch (error) {
          console.error('EmailJS test failed:', error);
          alert('EmailJS test failed: ' + (error.message || error));
          return false;
        }
      }

      document.getElementById('method').addEventListener('change', (e) => {
        const v = e.target.value;
        
        // Show/hide payment details
        document.getElementById('paymentDetails').style.display = v ? 'block' : 'none';
        document.querySelectorAll('.payment-details').forEach(el => el.style.display = 'none');
        if (v) {
          document.getElementById(v + 'Details').style.display = 'block';
        }
      });
      
      document.getElementById('screenshot').addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = () => { const img = document.getElementById('shotPrev'); img.src = reader.result; img.style.display='block'; };
        reader.readAsDataURL(file);
      });

      document.getElementById('confirm').onclick = async () => {
        if (!order) { 
          alert('No order found. Please go back to cart and try again.'); 
          return; 
        }
        
        console.log('=== ORDER CREATION DEBUG ===');
        console.log('Original order:', order);
        console.log('Order items:', order.items);
        console.log('First item keys:', Object.keys(order.items[0] || {}));
        console.log('First item:', order.items[0]);
        
        const emailInput = document.getElementById('email');
        const messageInput = document.getElementById('message');
        const screenshotInput = document.getElementById('screenshot');
        
        // Validate required fields
        const emailVal = emailInput.value.trim();
        const messageVal = messageInput.value.trim();
        const screenshotFile = screenshotInput.files[0];
        
        // Email validation regex
        const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        
        if (!emailVal || !emailRegex.test(emailVal)) {
          alert('Please enter a valid email address (e.g., example@domain.com)');
          emailInput.focus();
          return;
        }
        
        if (!messageVal) {
          alert('Please write your order details or message');
          messageInput.focus();
          return;
        }
        
        if (!screenshotFile) {
          alert('Please upload payment proof screenshot');
          screenshotInput.focus();
          return;
        }
        
        // Generate order ID
        const orderId = generateOrderId();
        
        try {
          // Process screenshot file
          const reader = new FileReader();
          reader.onload = async (e) => {
            const screenshotData = e.target.result;
            
            try {
              // Send email with order details using EmailJS
              console.log('Attempting to send email via EmailJS...');
              
              // Prepare email data
              const emailData = {
                to_email: 'birajshrestha145@gmail.com',
                from_email: emailVal,
                order_id: orderId,
                customer_email: emailVal,
                order_items: order.items.map(item => `${item.title} × ${item.quantity} — $${(item.priceCents/100).toFixed(2)}`).join('\n'),
                order_total: (order.totalCents/100).toFixed(2),
                customer_message: messageVal,
                message: messageVal,
                customer_note: messageVal,
                note: messageVal,
                payment_proof: 'Screenshot uploaded'
              };
              
              console.log('EmailJS data:', emailData);
              console.log('=== MESSAGE DEBUG ===');
              console.log('Message value:', messageVal);
              console.log('Message length:', messageVal.length);
              console.log('Message in emailData:', emailData.customer_message);
              console.log('=====================');
              
              // Send email using EmailJS
              const result = await emailjs.send(
                'service_a2r2ht3',  // Your EmailJS service ID
                'template_0bxfv93', // Your EmailJS template ID
                emailData
              );
              
              console.log('Email sent successfully via EmailJS:', result);
              
              // Create new order with proper product ID preservation
              const newOrder = {
                id: orderId,
                createdAt: new Date().toISOString(),
                email: emailVal,
                items: order.items.filter(i => (i.priceCents * i.quantity) > 0).map(item => {
                  // Ensure we have the correct product ID
                  const productId = item.productId || item.id || item.product_id;
                  console.log('Processing item:', item);
                  console.log('Product ID found:', productId);
                  
                  return {
                    productId: productId,
                    title: item.title,
                    quantity: item.quantity,
                    priceCents: item.priceCents
                  };
                }),
                totalCents: order.items.filter(i => (i.priceCents * i.quantity) > 0).reduce((s, i) => s + (i.priceCents * i.quantity), 0),
                message: messageVal,
                screenshot: screenshotData,
                status: 'pending'
              };
              
              console.log('New order created:', newOrder);
              console.log('Order items with product IDs:', newOrder.items);
              console.log('=== END ORDER CREATION DEBUG ===');
              
              // Save order
              const list = readOrders(); 
              list.unshift(newOrder); 
              writeOrders(list);
              
              // Clear form
              emailInput.value = '';
              messageInput.value = '';
              screenshotInput.value = '';
              document.getElementById('shotPrev').style.display = 'none';
              
              // Show success message
              alert(`Order #${orderId} placed successfully! Email sent. We will review your payment and send you the Canva links within 24 hours.`);
              
              // Clear cart and redirect
              localStorage.removeItem('cart-items');
              localStorage.removeItem('last-order');
              window.location.href = './index.html';
              
            } catch (emailError) {
              console.error('EmailJS failed:', emailError);
              console.error('Error details:', {
                service: 'service_a2r2ht3',
                template: 'template_0bxfv93',
                error: emailError.message || emailError
              });
              
              // Show specific error message
              let errorMessage = 'Email failed to send. ';
              if (emailError.message) {
                errorMessage += emailError.message;
              } else {
                errorMessage += 'Please check EmailJS configuration.';
              }
              
              alert(errorMessage);
              
              // Still save the order with proper product ID preservation
              const newOrder = {
                id: orderId,
                createdAt: new Date().toISOString(),
                email: emailVal,
                items: order.items.filter(i => (i.priceCents * i.quantity) > 0).map(item => {
                  const productId = item.productId || item.id || item.product_id;
                  return {
                    productId: productId,
                    title: item.title,
                    quantity: item.quantity,
                    priceCents: item.priceCents
                  };
                }),
                totalCents: order.items.filter(i => (i.priceCents * i.quantity) > 0).reduce((s, i) => s + (i.priceCents * i.quantity), 0),
                message: messageVal,
                screenshot: screenshotData,
                status: 'pending'
              };
              
              const list = readOrders(); 
              list.unshift(newOrder); 
              writeOrders(list);
              
              // Clear form
              emailInput.value = '';
              messageInput.value = '';
              screenshotInput.value = '';
              document.getElementById('shotPrev').style.display = 'none';
              
              alert(`Order #${orderId} saved! Email failed but order was recorded.`);
              console.log('Order saved successfully despite email failure');
              localStorage.removeItem('cart-items');
              localStorage.removeItem('last-order');
              window.location.href = './index.html';
            }
          };
          
          reader.readAsDataURL(screenshotFile);
          
        } catch (e) {
          console.error('Order processing failed:', e);
          alert('Failed to process order. Please try again.');
        }
      };
    </script>
  </body>
  </html>
