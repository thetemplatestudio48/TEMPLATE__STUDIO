<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin • Template Studio</title>
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body>
    <script>
      (function(){
        const PASSCODE = 'SISIMANU1';
        try {
          if (sessionStorage.getItem('admin-ok') === '1') return;
          const input = prompt('Enter admin passcode:');
          if (input !== PASSCODE) {
            alert('Access denied');
            window.location.href = '../index.html';
          } else {
            sessionStorage.setItem('admin-ok', '1');
          }
        } catch (e) {
          window.location.href = '../index.html';
        }
      })();
    </script>
    <header class="header">
      <div class="container row" style="display:flex;justify-content:space-between;align-items:center">
        <a class="brand" href="../index.html">Template Studio</a>
        <nav class="nav">
          <a href="../index.html">Store</a>
        </nav>
      </div>
    </header>
    <main class="container">
      <h1>Admin</h1>
      <div class="card" style="padding:16px; margin-bottom:16px;">
        <h3>Add / Edit Product</h3>
        <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px;">
          <input id="p_id" class="input" placeholder="ID (auto if empty)" />
          <input id="p_title" class="input" placeholder="Title" />
          <input id="p_price" type="number" step="0.01" class="input" placeholder="Price ($) e.g. 12.99" />
          <input id="p_thumb" class="input" placeholder="Thumbnail URL (https) or will be filled by upload" />
          <label class="btn" style="display:inline-flex;align-items:center;gap:8px">
            Upload thumbnail
            <input id="p_thumb_file" type="file" accept="image/*" style="display:none" />
          </label>
          <img id="p_thumb_prev" src="" alt="Preview" style="max-width:200px; max-height:120px; border:1px solid var(--border); border-radius:8px; display:none" />
          <input id="p_canva" class="input" placeholder="Canva Template URL" />
          <textarea id="p_desc" class="textarea" placeholder="Description"></textarea>
        </div>
        <div style="margin-top:12px;">
          <h4 style="margin:0 0 8px 0;">Categories (select where product should appear):</h4>
          <div style="display:flex;gap:16px;flex-wrap:wrap;">
            <label style="display:flex;align-items:center;gap:4px;">
              <input type="checkbox" id="cat_home" value="home" /> Home
            </label>
            <label style="display:flex;align-items:center;gap:4px;">
              <input type="checkbox" id="cat_ebook" value="ebook" /> Ebook
            </label>
            <label style="display:flex;align-items:center;gap:4px;">
              <input type="checkbox" id="cat_template" value="template" /> Template
            </label>
            <label style="display:flex;align-items:center;gap:4px;">
              <input type="checkbox" id="cat_resume" value="resume" /> Resume
            </label>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button id="save" class="btn primary">Save Product</button>
          <button id="reset" class="btn">Reset</button>
        </div>
      </div>

      <div class="card" style="padding:16px; margin-bottom:16px;">
        <div class="row">
          <h3>Products</h3>
        </div>
        <table class="table">
          <thead><tr><th>Title</th><th>Price</th><th>Categories</th><th>Actions</th></tr></thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <div class="card" style="padding:16px; margin-bottom:16px;">
        <h3>Orders Management</h3>
        <div style="margin-bottom:12px;">
          <button class="btn" onclick="cleanupOrderIds()">Cleanup Order IDs</button>
          <button class="btn" onclick="fixOrderProductIds()">Fix Order Product IDs</button>
          <button class="btn" onclick="testProductMatching()">Test Product Matching</button>
          <span class="muted" style="margin-left:8px;">Convert existing orders to sequential IDs (001, 002, 003...)</span>
        </div>
        <div id="ordersList" style="margin-top:12px;">
          <div class="muted">Loading orders...</div>
          </div>
      </div>
    </main>
    <footer class="footer">© <span id="year"></span> Template Studio</footer>

    <script>
      const STORAGE_KEY = 'admin-products';
      const fmt = v => (v / 100).toFixed(2);
      const read = () => JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null');
      const write = (list) => {
        try {
          // Validate the data before saving
          if (!Array.isArray(list)) {
            console.error('Invalid product list format');
            throw new Error('Invalid product list format');
          }
          
          // Ensure all required fields are present
          list.forEach((product, index) => {
            if (!product.id || !product.title) {
              console.error(`Invalid product at index ${index}`);
              throw new Error(`Invalid product at index ${index}`);
            }
          });

          // Save to localStorage
          localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
          console.log(`Successfully saved ${list.length} products`);
          
          // Verify the save was successful
          const verification = localStorage.getItem(STORAGE_KEY);
          if (!verification) {
            throw new Error('Failed to verify saved data');
          }
        } catch (e) {
          console.error('Error saving products:', e);
          alert('Error saving products. Please try again.');
          throw e;
        }
      };

      const $ = (id) => document.getElementById(id);

      function getProducts() {
        try {
          const data = read();
          return Array.isArray(data) ? data : [];
        } catch (e) {
          console.error('Error reading products:', e);
          return [];
        }
      }

      function setProducts(list) {
        if (!Array.isArray(list)) {
          console.error('Invalid product list');
          return;
        }
        write(list);
      }
      function uid() { return 'p_' + Math.random().toString(36).slice(2, 9); }

      function fillForm(p) {
        $('p_id').value = p?.id || '';
        $('p_title').value = p?.title || '';
        $('p_price').value = (p?.priceCents ? (p.priceCents / 100).toFixed(2) : '');
        $('p_thumb').value = p?.thumbnailUrl || '';
        if (p?.thumbnailUrl) { const img=$('p_thumb_prev'); img.src=p.thumbnailUrl; img.style.display='block'; } else { const img=$('p_thumb_prev'); img.removeAttribute('src'); img.style.display='none'; }
        $('p_canva').value = p?.canvaTemplateUrl || '';
        $('p_desc').value = p?.description || '';
        
        // Reset all checkboxes
        $('cat_home').checked = false;
        $('cat_ebook').checked = false;
        $('cat_template').checked = false;
        $('cat_resume').checked = false;
        
        // Check the categories this product belongs to
        if (p?.categories) {
          p.categories.forEach(cat => {
            if (cat === 'home') $('cat_home').checked = true;
            if (cat === 'ebook') $('cat_ebook').checked = true;
            if (cat === 'template') $('cat_template').checked = true;
            if (cat === 'resume') $('cat_resume').checked = true;
          });
        }
      }

      function readForm() {
        const categories = [];
        if ($('cat_home').checked) categories.push('home');
        if ($('cat_ebook').checked) categories.push('ebook');
        if ($('cat_template').checked) categories.push('template');
        if ($('cat_resume').checked) categories.push('resume');
        
        return {
          id: $('p_id').value.trim() || uid(),
          title: $('p_title').value.trim(),
          priceCents: Math.round(parseFloat($('p_price').value || '0') * 100) || 0,
          thumbnailUrl: $('p_thumb').value.trim(),
          canvaTemplateUrl: $('p_canva').value.trim(),
          description: $('p_desc').value.trim(),
          categories: categories
        };
      }

      function render() {
        const rows = $('rows'); rows.innerHTML='';
        getProducts().forEach(p => {
          const categories = p.categories ? p.categories.join(', ') : 'None';
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${p.title}</td><td>$${fmt(p.priceCents)}</td><td>${categories}</td><td>
            <button class="btn" data-edit="${p.id}">Edit</button>
            <button class="btn danger" data-del="${p.id}">Delete</button></td>`;
          rows.appendChild(tr);
        });
        
        // Also render orders
        renderOrders();
      }

      function renderOrders() {
        const ordersList = document.getElementById('ordersList');
        const orders = JSON.parse(localStorage.getItem('orders') || '[]');
        
        if (!orders.length) {
          ordersList.innerHTML = '<div class="muted">No orders yet.</div>';
          return;
        }
        
        let html = '';
        orders.forEach(order => {
          const orderDate = new Date(order.createdAt).toLocaleDateString();
          const statusColor = order.status === 'pending' ? '#ffc107' : 
                              order.status === 'paid' ? '#28a745' : 
                              order.status === 'confirmed' ? '#17a2b8' : '#6c757d';
          
          html += `
            <div class="card" style="padding:12px; margin-bottom:12px; border-left:4px solid ${statusColor}">
              <div class="row" style="justify-content:space-between;align-items:flex-start">
                <div>
                  <h4 style="margin:0 0 8px 0;">Order #${order.id}</h4>
                  <p style="margin:0 0 4px 0;"><strong>Email:</strong> ${order.email}</p>
                  <p style="margin:0 0 4px 0;"><strong>Date:</strong> ${orderDate}</p>
                  <p style="margin:0 0 4px 0;"><strong>Total:</strong> $${(order.totalCents/100).toFixed(2)}</p>
                  <p style="margin:0 0 4px 0;"><strong>Status:</strong> <span style="color:${statusColor};font-weight:bold">${order.status}</span></p>
                  <p style="margin:0 0 4px 0;"><strong>Message:</strong> ${order.message}</p>
                  <div style="margin:8px 0;">
                    <strong>Items:</strong>
                    <ul style="margin:4px 0 0 16px;">
                      ${order.items.map(item => `<li>${item.title} × ${item.quantity} — $${(item.priceCents/100).toFixed(2)}</li>`).join('')}
                    </ul>
                  </div>
                </div>
                <div style="text-align:right;">
                  <button class="btn" onclick="viewPaymentProof('${order.id}')">View Payment</button>
                  ${order.status === 'pending' ? `<button class="btn primary" onclick="confirmPayment('${order.id}')">Confirm Payment</button>` : ''}
                  ${order.status === 'paid' ? `<button class="btn success" onclick="releaseCanvaLinks('${order.id}')">Release Links</button>` : ''}
                  <button class="btn danger" onclick="deleteOrder('${order.id}')">Delete</button>
                </div>
              </div>
            </div>
          `;
        });
        
        ordersList.innerHTML = html;
      }
      
      function viewPaymentProof(orderId) {
        const orders = JSON.parse(localStorage.getItem('orders') || '[]');
        const order = orders.find(o => o.id === orderId);
        if (!order || !order.screenshot) {
          alert('Payment proof not found');
          return;
        }
        
        // Create modal to show payment proof
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;display:flex;align-items:center;justify-content:center;';
        
        modal.innerHTML = `
          <div class="panel" style="max-width:90%;max-height:90%;overflow:auto;">
            <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:16px;">
              <h3>Payment Proof - Order #${order.id}</h3>
              <button class="btn" onclick="this.closest('.modal').remove()">Close</button>
            </div>
            <img src="${order.screenshot}" alt="Payment Proof" style="max-width:100%;height:auto;border:1px solid var(--border);border-radius:8px;" />
            <div style="margin-top:16px;">
              <p><strong>Customer Email:</strong> ${order.email}</p>
              <p><strong>Order Total:</strong> $${(order.totalCents/100).toFixed(2)}</p>
              <p><strong>Customer Message:</strong> ${order.message}</p>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
      }
      
      function confirmPayment(orderId) {
        if (!confirm('Confirm that payment has been received for this order?')) return;
        
        const orders = JSON.parse(localStorage.getItem('orders') || '[]');
        const orderIndex = orders.findIndex(o => o.id === orderId);
        if (orderIndex === -1) return;
        
        orders[orderIndex].status = 'paid';
        orders[orderIndex].paymentConfirmedAt = new Date().toISOString();
        localStorage.setItem('orders', JSON.stringify(orders));
        
        renderOrders();
        alert('Payment confirmed! Order status updated to "Paid".');
      }
      
      function releaseCanvaLinks(orderId) {
        const orders = JSON.parse(localStorage.getItem('orders') || '[]');
        const order = orders.find(o => o.id === orderId);
        if (!order) return;
        
        console.log('Order items:', order.items);
        
        // Get Canva links for the ordered products
        const products = getProducts();
        console.log('Available products:', products);
        
        const canvaLinks = order.items.map(item => {
          console.log('Looking for product with ID:', item.productId);
          console.log('Available product IDs:', products.map(p => p.id));
          
          const product = products.find(p => p.id === item.productId);
          console.log('Found product:', product);
          
          if (!product) {
            return { found: false, message: `Product ID "${item.productId}" not found in database` };
          }
          if (!product.canvaTemplateUrl || product.canvaTemplateUrl.trim() === '') {
            return { found: false, message: `Canva link not set for product "${product.title}"` };
          }
          return { found: true, link: product.canvaTemplateUrl, title: product.title };
        });
        
        console.log('Canva links result:', canvaLinks);

        // Prepare email content
        const validLinks = canvaLinks.filter(item => item.found);
        const emailBody = `Dear Customer,

Thank you for your purchase from Template Studio!

Here are your Canva template links:
${validLinks.map(item => `\n${item.title}:\n${item.link}`).join('\n\n')}

If you have any questions, please don't hesitate to contact us.

Best regards,
Template Studio Team`;

        const emailSubject = `Your Template Studio Order #${order.id} - Canva Links`;
        const mailtoLink = `mailto:${order.email}?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
        
        // Create modal to show Canva links
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;display:flex;align-items:center;justify-content:center;';
        
        const linksHtml = canvaLinks.map((item, index) => {
          if (item.found) {
            return `
              <div style="margin:8px 0;padding:8px;background:#d4edda;border:1px solid #c3e6cb;border-radius:4px;color:#155724;">
                <strong>Product ${index + 1}:</strong> ${item.title}<br>
                <a href="${item.link}" target="_blank" style="word-break:break-all;color:#155724;">${item.link}</a>
              </div>
            `;
          } else {
            return `
              <div style="margin:8px 0;padding:8px;background:#f8d7da;border:1px solid #f5c6cb;border-radius:4px;color:#721c24;">
                <strong>Product ${index + 1}:</strong> ${item.message}<br>
                <span class="muted">Please add Canva link in product settings</span>
              </div>
            `;
          }
        }).join('');
        
        modal.innerHTML = `
          <div class="panel" style="max-width:90%;max-height:90%;overflow:auto;">
            <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:16px;">
              <h3>Canva Links - Order #${order.id}</h3>
              <button class="btn" onclick="this.closest('.modal').remove()">Close</button>
            </div>
            <div style="margin-bottom:16px;">
              <p><strong>Customer Email:</strong> ${order.email}</p>
              <p><strong>Order Total:</strong> $${(order.totalCents/100).toFixed(2)}</p>
            </div>
            <div style="margin-bottom:16px;">
              <h4>Canva Template Links:</h4>
              ${linksHtml}
            </div>
            <div style="margin-top:16px;">
              <div class="row" style="gap:8px;">
                <a href="${mailtoLink}" class="btn success">Send Links via Email</a>
                <button class="btn primary" onclick="markAsDelivered('${orderId}')">Mark as Delivered</button>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
      }
      
      function markAsDelivered(orderId) {
        if (!confirm('Mark this order as delivered?')) return;
        
        const orders = JSON.parse(localStorage.getItem('orders') || '[]');
        const orderIndex = orders.findIndex(o => o.id === orderId);
        if (orderIndex === -1) return;
        
        orders[orderIndex].status = 'delivered';
        orders[orderIndex].deliveredAt = new Date().toISOString();
        localStorage.setItem('orders', JSON.stringify(orders));
        
        renderOrders();
        alert('Order marked as delivered!');
        
        // Close the modal
        const modal = document.querySelector('.modal');
        if (modal) modal.remove();
      }

      function deleteOrder(orderId) {
        if (!confirm('Are you sure you want to delete this order?')) return;
        const orders = JSON.parse(localStorage.getItem('orders') || '[]');
        const initialLength = orders.length;
        const newOrders = orders.filter(order => order.id !== orderId);
        if (newOrders.length < initialLength) {
          localStorage.setItem('orders', JSON.stringify(newOrders));
          renderOrders();
          alert('Order deleted!');
        } else {
          alert('Order not found.');
        }
      }

      function cleanupOrderIds() {
        const orders = JSON.parse(localStorage.getItem('orders') || '[]');
        const newOrders = [];
        let currentId = 1;
        orders.forEach(order => {
          newOrders.push({ ...order, id: currentId.toString().padStart(3, '0') });
          currentId++;
        });
        localStorage.setItem('orders', JSON.stringify(newOrders));
        renderOrders();
        alert('Order IDs cleaned up and converted to sequential.');
      }

      function fixOrderProductIds() {
        const orders = JSON.parse(localStorage.getItem('orders') || '[]');
        const products = getProducts();
        
        console.log('=== FIXING ORDER PRODUCT IDs ===');
        console.log('Available products:', products.map(p => ({ id: p.id, title: p.title })));
        
        const fixedOrders = orders.map(order => {
          console.log(`\nFixing order #${order.id}:`);
          const fixedItems = order.items.map(item => {
            console.log(`  Item: ${item.title}`);
            
            // Try to find the product by title if productId is missing
            let productId = item.productId || item.id;
            
            if (!productId && item.title) {
              const foundProduct = products.find(p => p.title === item.title);
              if (foundProduct) {
                productId = foundProduct.id;
                console.log(`    Found product by title: ${foundProduct.id}`);
              } else {
                console.log(`    No product found for title: ${item.title}`);
              }
            }
            
            console.log(`    Final productId: ${productId}`);
            
            return {
              productId: productId,
              title: item.title,
              quantity: item.quantity,
              priceCents: item.priceCents
            };
          });
          
          return { ...order, items: fixedItems };
        });
        
        localStorage.setItem('orders', JSON.stringify(fixedOrders));
        renderOrders();
        console.log('=== ORDER PRODUCT IDs FIXED ===');
        alert('Order product IDs fixed! Check console for details.');
      }

      function testProductMatching() {
        const products = getProducts();
        const orderItems = JSON.parse(localStorage.getItem('orders') || '[]').flatMap(order => order.items);

        console.log('Available Products:', products);
        console.log('Order Items:', orderItems);

        const unmatchedItems = orderItems.filter(orderItem => {
          const product = products.find(p => p.id === orderItem.productId);
          return !product || !product.canvaTemplateUrl || product.canvaTemplateUrl.trim() === '';
        });

        if (unmatchedItems.length === 0) {
          alert('All order items have matching products and Canva links.');
          return;
        }

        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;display:flex;align-items:center;justify-content:center;';

        let html = '<h3>Unmatched Products in Orders</h3>';
        html += '<p>The following order items do not have a matching product or a set Canva link in the database:</p>';
        html += '<ul style="margin-top:10px;padding-left:20px;">';
        unmatchedItems.forEach((item, index) => {
          html += `<li>Order #${item.orderId} - Item #${index + 1}: ${item.title} (Product ID: ${item.productId})</li>`;
        });
        html += '</ul>';
        html += '<p>Please check the product settings for these products to ensure they have a valid Canva link.</p>';

        modal.innerHTML = `
          <div class="panel" style="max-width:90%;max-height:90%;overflow:auto;">
            ${html}
          </div>
        `;

        document.body.appendChild(modal);
        modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
      }

      document.getElementById('save').onclick = async () => {
        try {
          console.log('Save button clicked');
          
          const p = readForm();
          console.log('Form data:', p);
          
          if (!p.title || !p.priceCents || !p.thumbnailUrl || !p.canvaTemplateUrl || !p.description) {
            alert('Fill all fields');
            console.log('Validation failed - missing fields');
            return;
          }
          
          // Prevent saving products with $0.00 price
          if (p.priceCents === 0) {
            alert('Product price cannot be $0.00. Please set a valid price.');
            console.log('Validation failed - price is 0');
            return;
          }
          
          // Prevent saving products without categories
          if (!p.categories || p.categories.length === 0) {
            alert('Please select at least one category for the product.');
            console.log('Validation failed - no categories selected');
            return;
          }
          
          console.log('Validation passed, saving product...');
          
          const products = getProducts();
          console.log('Current products:', products);
          
          const existingIndex = products.findIndex(pp => pp.id === p.id);
          if (existingIndex >= 0) {
            products[existingIndex] = p;
            console.log('Updated existing product at index:', existingIndex);
          } else {
            products.push(p);
            console.log('Added new product');
          }
          
          setProducts(products);
          console.log('Products saved to localStorage');
          
          fillForm();
          render();
          alert('Product saved successfully!');
          
        } catch (error) {
          console.error('Error saving product:', error);
          alert('Error saving product: ' + error.message);
        }
      };
      document.getElementById('reset').onclick = () => fillForm({});

      document.addEventListener('click', (e) => {
        const idE = e.target && e.target.getAttribute && e.target.getAttribute('data-edit');
        const idD = e.target && e.target.getAttribute && e.target.getAttribute('data-del');
        if (idE) { const p = getProducts().find(x => x.id === idE); if (p) fillForm(p); }
        if (idD) { if (confirm('Delete this product?')) { setProducts(getProducts().filter(x => x.id !== idD)); render(); } }
        // Removed old order-related click handlers
      });

      // Handle thumbnail file upload -> convert to data URL and store into the URL field
      document.getElementById('p_thumb_file').addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const dataUrl = reader.result;
          document.getElementById('p_thumb').value = dataUrl;
          const img = document.getElementById('p_thumb_prev'); img.src = dataUrl; img.style.display = 'block';
        };
        reader.readAsDataURL(file);
      });

      // Initialize admin panel
      function init() {
        try {
          console.log('Admin panel initializing...');
          
          // Check if we have products, if not get from localStorage
          const existingProducts = read();
          if (!existingProducts || !Array.isArray(existingProducts)) {
            console.log('No valid products found, creating empty list');
            write([]);
          } else {
            console.log('Found existing products:', existingProducts.length);
          }
          
          console.log('Rendering admin panel...');
          render();
          renderOrders();
          document.getElementById('year').textContent = new Date().getFullYear();
          
          console.log('Admin panel initialized successfully');
        } catch (error) {
          console.error('Error initializing admin panel:', error);
          alert('Error initializing admin panel: ' + error.message);
        }
      }
      
      // Wait for DOM to be ready, then initialize
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    </script>
  </body>
  </html>
